# [Как правильно готовить вместе с Chef](http://foodtaster.github.io/dev-highload-2013/)

Поднимите руки те кто является разработчиками! Кто знает, что такое
девопс? Кто когда-либо работал с Chef или любой другой системой
управления конфигурацией.

### N+1 изменений

Давайте посчитаем. На проекте у вас, например, пять разработчиков. Так
же есть CI, стэйджинг и продакшен, работающий, напрмер, на трех
машинах.

Итого получается 9 одинаковых энвайроментов. Поднимите руки те кто за
последнюю неделю поднимал приложение на своем новом макбуке или для
нового разработчика. Каждую правку в конфигурации энвайромента нужно
будет повторить девять раз. Те, кто вносил такие изменения знает, сколько
времени это может занять. У здравомяслящего разработчика должно
появиться желание это автоматизировать.

### Трамвайно-зависимаю инфраструктура

Кому знакома ситуация - когда то что происходит на сервере известно
лишь условному Пете или что еще хуже, на сервер пустили нескольких
условных Петь и теперь что там происходит не изветстно никому?
Заставить админов писать документацию еще сложнее, чем разработчиков.
В самом худшем случае вы можете попасть в такую ситуацию, что
серверные машины будет просто страшно трогать.

### Infrastructure as a Code

Представьте, что вся установка инфраструктуры осуществляется с помощью
кода, лежащего под source control и обложеного тестами. Чтобы поднять
новую машину или кластер, вам достаточно будет просто выполнить одну
или несколько команд. Чтобы понять, каким образом настроен тот или
иной сервер, достаточно просто прочитать код.

Именно это и делает Chef.

### Что такое chef?

Chef - это система управления конфигурацией.

Если очень просто, то Chef запускает на конфигурируемой машине
скрипт с правами суперпользователя, который и осуществляет
конфигурирование. Далее мы будем машины (сервера) называть нодами,
так как это принятая терминология в Chef-коммьюнити.

Для каждой ноды существует набор данных - аттрибутов, имеющих
произвольную структуру (JSON). Аттрибуты - это конфигурация ноды.

У ноды есть специальный аттрибут - run list - где перечислены рецепты,
по которым нужно ноду приготовить. Рецепты группируются в кукбуки.

*Кукбуки* это основные единицы дистрибуции конфигурационных скриптов,
которые умеют сделать что-нибудь полезное с машиной, например
поставить postgresql или nginx.

Множество кукбуков на разные случаи можно найти на github, есть также
официальный репозиторий chef кукбуков на сайте
[http://community.opscode.com/].

### Chef Run

Процесс "приготовления" ноды выглядит следующим образом. От
суперпользователя запускается процесс chef-а - либо chef-client, либо
chef-solo.

Этот процесс получает аттрибуты ноды. Если запуск "безсерверный", то
эти аттрибуты лежат в файле. В противном случае, чеф запрашивает
аттрибуты с сервера.

Далее по аттрибуту run_list чеф понимает, какие рецепты ему нужно
будет выполнить. Он либо стягивает кукбуки с этими рецептами с
сервера, либо находит их в файловой системе.

Далее следует т.н. "компиляция" рецептов. По исходному коду рецептов
чеф вычисляет желаемое состояние ноды, и так же сравнивает его с
фактическим состоянием. Таким образом он собирает дифф между этими
двумя состояниями, то есть тот объем работы, который необходимо сделать.

## Звучит прекрасно, но как начать?

Для того чтобы начать упражняться с chef, удобно использовать виртуализацию.
Подняли виртуальную машинку, поигрались - испортили, взяли другую.

Для удобной автоматизированной работы с различными системами
виртуализации, существует утилита
[Vagrant](http://www.vagrantup.com/). Она позволяет положить в корень
проекта специальный файл-манифест -
[Vagrantfile](http://docs-v1.vagrantup.com/v1/docs/vagrantfile.html),
в котором описано - какие виртуальные машины нужны для этого проекта,
где их скачать (box), как настроить сеть и сколько системных ресурсов
выделить.

В vagrant есть понятие box - заготовленный образ виртуальной машины,
доступный по определенному url [http://www.vagrantbox.es/].

А еще vagrang поддерживает provisioning виртуальных машин с помощью
chef, chef-solo, puppet etc.

### Vagrant & Chef

Vagrant - хороший инструмент, чтобы начать эксперименты с чеф. С
помощью удобного комманд-лайн интерфейса вы можете запустить на ВМ чеф
и посмотреть результаты его работы.

Чем он хорош? Тем, что у нас есть песочница для прогона
разрабатываемого кукбука.

Чем этот воркфлоу плох? Тем, что в нем много ручной работы. Проверка
результатов работы не автоматизирована, это сродни прощелкиванию
приложения в браузере (ручному тестированию). Рано или поздно вам
захочется это автоматизировать.

### TDD & CI

Как мы можем превратить ручное тестирование в автоматизированное? Те
SSH-команды, которые вы вручную выполняете на ВМ после прогона - это и
есть тесты. Получается, что осталось придумать удобное средство для
превращения их в код.

### Foodtaster

Фудтейстер - это библиотека для автоматизированного тестирования
кукбуков, базирующаяся на RSpec и Vagrant. Foodtaster удобен не только
для проверки работоспособности кукбуков, но и как средство разработки.
